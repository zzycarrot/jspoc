# 使用Node.js LTS版本作为基础镜像
FROM node:20-alpine

# 设置容器工作目录
WORKDIR /usr/src/app

# 单独复制package.json以利用Docker缓存层
COPY package*.json ./

# 安装生产依赖 - 使用NODE_ENV指定环境
RUN npm install --production --silent

# 复制应用代码
COPY . .

# 应用安全加固
RUN apk add --no-cache dumb-init && \
    chown -R node:node . && \
    chmod -R 755 /usr/src/app

# 切换到非root用户
USER node

# 暴露服务端口
EXPOSE 3000

# 使用dumb-init处理进程信号
ENTRYPOINT ["/usr/bin/dumb-init", "--"]

# 启动应用
CMD ["node", "app.js"]